# =============================================================================
# Deploy to Production using PPDS-ALM
# =============================================================================
# Simplified example showing how to use ppds-alm reusable workflows.
#
# This workflow deploys the managed solution to the Production environment
# when the main branch is updated, with manual confirmation for safety.
#
# Prerequisites:
#   - GitHub Environment 'Prod' configured with Dataverse credentials
#   - Environment protection rules (recommended: required reviewers)
#   - ppds-alm repository accessible
#
# For the full-featured deployment with confirmation, see cd-prod.yml
# which includes additional safety measures.
# =============================================================================

name: 'Deploy to Prod (PPDS-ALM Example)'

on:
  # Deploy when main branch is updated with solution changes
  push:
    branches:
      - main
    paths:
      - 'solutions/PPDSDemo/src/**'

  # Manual trigger with confirmation
  workflow_dispatch:
    inputs:
      confirm_production:
        description: 'Type "DEPLOY" to confirm production deployment'
        required: true
        default: ''

jobs:
  # Fail if manual trigger without confirmation
  require-confirmation:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.confirm_production != 'DEPLOY'
    runs-on: ubuntu-latest
    steps:
      - name: Deployment not confirmed
        run: |
          echo "::error::Production deployment requires confirmation. Type 'DEPLOY' in the confirm_production input."
          exit 1

  deploy:
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.confirm_production == 'DEPLOY')
    uses: joshsmithxrm/ppds-alm/.github/workflows/solution-deploy.yml@v1
    with:
      environment-name: Prod
      environment-url: ${{ vars.DATAVERSE_URL }}
      solution-name: PPDSDemo
      solution-folder: solutions/PPDSDemo/src
      managed: true
    secrets:
      client-id: ${{ secrets.CLIENT_ID }}
      client-secret: ${{ secrets.CLIENT_SECRET }}
      tenant-id: ${{ secrets.TENANT_ID }}
